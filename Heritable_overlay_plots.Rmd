---
title: "Heritable_overlay_plots"
output: html_document
---

#This code is specifically for data and individuals derived from Male 212.
#For this code to work the "Date & Time" column from the xlsx file generated by the logger software must be manually deleted from that file or it will cause parsing issues that prevent this program from working. That column can be manually deleted and the resulting files should be placed in "ENU_heritable_trimmed" where this code will look for them.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library("readxl")
library("tidyverse")
library("lubridate")
library("readODS")
```

List files with temp measurements

```{r temp_measures, echo=FALSE}
file.list <- list.files(path = "ENU_heritable_trimmed", pattern='*.xlsx')
file.list
level.inc <- c(20, 5)
level.light <- c(0, 1)
```

# Function to give me the time when measurements are performed

```{r temp_measures, echo=FALSE}
return.time <- function(x) {
  x <- x + 1080
  date <- as.Date("2000-01-01") + (x%/%1440)
  hour <- x %% (60 * 24) %/% 60
  minute <- x %% (60 * 24) %% 60
  return <- as_datetime(paste(date, toString(hour), toString(minute), "0", sep = " "))
}
```


Read excel files, assign new name and add DHM, Incubator temperature(°C) and light variables

```{r temp_measures, echo=FALSE}
for(x in file.list) {
  file.name <- paste("mouse", substr(x, 1, 4), sep = "_")
  if(!file.exists(paste("ENU_heritable_processed/", file.name, ".csv", sep = ""))){
    temp <- read_xlsx(paste("ENU_heritable_trimmed/", x, sep = ""))
    time <- seq(0, by = 10, length.out = nrow(temp))
    temp$"Time(min)" <- seq(0, by = 10, length.out = nrow(temp))
    temp$"HM" <- do.call("c", lapply(time, return.time))
    temp$"Incubator temperature" <- factor(20, levels = level.inc)
    temp$"Incubator temperature"[217:360] <- as.factor(5)
    temp$"light" <- factor(0, levels = level.light)
    temp$"light"[73:144] <- as.factor(1)
    temp$"light"[217:288] <- as.factor(1)
    temp$"light"[361:432] <- as.factor(1)
    temp$"light"[505:nrow(temp)] <- as.factor(1)
    file.dest <- paste("ENU_heritable_processed/", file.name, ".csv", sep = "")
    write.csv(temp, file.dest, row.names = FALSE)
    print(paste(file.name, "written as csv"))
  }
}
```
#At this point the above code will have added an extra "." to the filename of any mouse that has a 3 digit number. That must be deleted manually. This can be avoided by making new csvs in the temporary directory and then copying them over, rather than running this entire code.
#List all files with temperature measures

```{r temp_measures, echo=FALSE}
file.listprocessed <- list.files(path = "ENU_heritable_processed", pattern='*.csv')
file.listprocessed
```

#Read csv files, assign new name and add the time variable

```{r temp_measures, echo=FALSE}
for(x in file.listprocessed) {
  assign(x, 
         read_csv(paste("ENU_heritable_processed/" , x, sep = ""), col_types = 
                    cols(
                      "Temperature" = col_double(),
                      "Time(min)" =col_factor(),
                      "HM" = col_datetime(),
                      "Incubator temperature" = col_factor(),
                      "light" = col_factor()
                    )
         )
  )
}
```

# Overlay Graphs
# Create plot for all mice together in Overlay (alpha = 0.1)

```{r temp_measures, echo=FALSE}
temp <- slice_head(get(file.listprocessed[1]), n = 502)
ticks <- seq(min(temp$HM), max(temp$HM) + 43200, by = 43200)
cold.start <- min(temp$HM) + 129600
cold.end <- min(temp$HM) + 216000
anotation.rt <- c(min(temp$HM) + 64800, min(temp$HM) + 259200)
anotation.cold <- min(temp$HM) + 172800
rects <- tibble(
  xstart = seq(min(temp$HM), max(temp$HM), by = 43200), 
  xend = seq(min(temp$HM) + 43200, max(temp$HM) + 43200, by = 43200),
  light = c("off", "on", "off", "on", "off", "on", "off"))
all.data <- ggplot() +
  scale_x_datetime(breaks = ticks, date_labels = "%H:%M")
for(x in file.listprocessed) {
  temp <- get(x)
  temp <- slice_head(temp, n = 502)
  start <- temp$HM[1]
  end <- temp$HM[502]
  all.data <- all.data +
    geom_line(data = temp, aes(x = `HM`, y = `Temperature`), alpha = 0.1)
}
all.data <- all.data +
  geom_vline(xintercept = cold.start, linetype="dotted", color = "blue", size = 1) +
  geom_vline(xintercept = cold.end, linetype="dotted", color = "blue", size = 1) +
  geom_rect(data = rects, aes(ymin = -Inf, ymax = Inf, xmin = xstart, xmax = xend, fill = light), alpha = 0.25) +
  scale_fill_manual(values=c("off" = "grey90", "on" = "lemonchiffon1")) +
  annotate("text", x = anotation.rt, y = c(32, 32), label= "20°C") + 
  annotate("text", x = anotation.cold, y = 32, label= "5°C") + 
  xlab("Time [hh:mm]") + ylab("Temperature")
print(all.data)
ggsave("Data_overlay.png", device = "png", path = "Overlay_heritable", width = 20, height = 10, units = "cm")
```

# Make list of males/females

```{r temp_measures, echo=FALSE}
list <- list.files(path = "ENU heritable", pattern='*.ods')
gender <- as_tibble(read_ods(paste("ENU heritable/", list[1], sep = "")))
list.males <- filter(gender, gender == "m")
list.females <- filter(gender, gender == "f")
```

#Plot combined overlay graph of only males

```{r temp_measures, echo=FALSE}
males.data <- ggplot() +
  scale_x_datetime(breaks = ticks, date_labels = "%H:%M") +
  scale_y_continuous(limits = c( 31, 40))

for(x in list.males$`mouse`) {
  print(x)
  temp <- get(paste("mouse_", x, ".csv", sep = ""))
  temp <- slice_head(temp, n = 502)
  start <- temp$HM[1]
  end <- temp$HM[502]
  males.data <- males.data +
    geom_line(data = temp, aes(x = `HM`, y = `Temperature`), alpha = 0.1)
}

males.data <- males.data +
  geom_vline(xintercept = cold.start, linetype="dotted", color = "blue", size = 1) +
  geom_vline(xintercept = cold.end, linetype="dotted", color = "blue", size = 1) +
  geom_rect(data = rects, aes(ymin = -Inf, ymax = Inf, xmin = xstart, xmax = xend, fill = light), alpha = 0.25) +
  scale_fill_manual(values=c("off" = "grey90", "on" = "lemonchiffon1")) +
  annotate("text", x = anotation.rt, y = c(32, 32), label= "20°C") + 
  annotate("text", x = anotation.cold, y = 32, label= "5°C") + 
  xlab("Time [hh:mm]") + ylab("Temperature")

print(males.data)
ggsave("Data_overlay_males.png", device = "png", path = "Overlay_heritable", width = 20, height = 10, units = "cm")

```

# Plot every male animal over all male data

```{r temp_measures, echo=FALSE}
for(x in list.males$`mouse`) {
  temp <- get(paste("mouse_", x, ".csv", sep = ""))
  temp <- slice_head(temp, n = 502)
  males.data +
    geom_line(data = temp, aes(x = `HM`, y = `Temperature`)) +
    labs(title = x)
  if(!file.exists(paste("Overlay_heritable/", substr(x, 1, 9), "_overlay_males.png", sep = ""))) {
    ggsave(paste("mouse_", substr(x, 1, 9), "overlay_males.png", sep = "_"), device = "png", path = "Overlay_heritable", width = 20, height = 10, units = "cm")
    print(paste("mouse_", substr(x, 1, 9), " overlay_males", " written as png", sep = ""))
  }
}
```

#Plot combined overlay graph of only females

```{r temp_measures, echo=FALSE}
females.data <- ggplot() +
  scale_x_datetime(breaks = ticks, date_labels = "%H:%M") +
  scale_y_continuous(limits = c( 31, 40))

for(x in list.females$`mouse`) {
  print(x)
  temp <- get(paste("mouse_", x, ".csv", sep = ""))
  temp <- slice_head(temp, n = 502)
  start <- temp$HM[1]
  end <- temp$HM[502]
  females.data <- females.data +
    geom_line(data = temp, aes(x = `HM`, y = `Temperature`), alpha = 0.1)
}

females.data <- females.data +
  geom_vline(xintercept = cold.start, linetype="dotted", color = "blue", size = 1) +
  geom_vline(xintercept = cold.end, linetype="dotted", color = "blue", size = 1) +
  geom_rect(data = rects, aes(ymin = -Inf, ymax = Inf, xmin = xstart, xmax = xend, fill = light), alpha = 0.25) +
  scale_fill_manual(values=c("off" = "grey90", "on" = "lemonchiffon1")) +
  annotate("text", x = anotation.rt, y = c(32, 32), label= "20°C") + 
  annotate("text", x = anotation.cold, y = 32, label= "5°C") + 
  xlab("Time [hh:mm]") + ylab("Temperature")

print(females.data)
ggsave("Data_overlay_females.png", device = "png", path = "Overlay_heritable", width = 20, height = 10, units = "cm")
```

#  Plot every female animal over all female data

```{r temp_measures, echo=FALSE}
for(x in list.females$`mouse`) {
  temp <- get(paste("mouse_", x, ".csv", sep = ""))
  temp <- slice_head(temp, n = 502)
  females.data +
    geom_line(data = temp, aes(x = `HM`, y = `Temperature`)) +
    labs(title = x)
  if(!file.exists(paste("Overlay_heritable/", substr(x, 1, 9), "_overlay_males.png", sep = ""))) {
    ggsave(paste("mouse_", substr(x, 1, 9), "overlay_females.png", sep = "_"), device = "png", path = "Overlay_heritable", width = 20, height = 10, units = "cm")
    print(paste("mouse_", substr(x, 1, 9), " overlay_females", " written as png", sep = ""))
  }
}
```
